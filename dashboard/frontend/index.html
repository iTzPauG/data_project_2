<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Location Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #0f1117;
      color: #e2e8f0;
      height: 100vh;
      display: flex;
      overflow: hidden;
    }

    /* ── Sidebar ─────────────────────────────────────────────── */
    #sidebar {
      width: 280px;
      min-width: 280px;
      background: #1a1d27;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #2d3148;
      overflow: hidden;
    }

    #sidebar-header {
      padding: 20px 16px 12px;
      border-bottom: 1px solid #2d3148;
    }

    #sidebar-header h1 {
      font-size: 15px;
      font-weight: 600;
      color: #f1f5f9;
      letter-spacing: 0.02em;
    }

    #sidebar-header p {
      font-size: 11px;
      color: #64748b;
      margin-top: 2px;
    }

    /* Status pill */
    #status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 10px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 500;
      background: #2d3148;
      color: #94a3b8;
      transition: background 0.3s, color 0.3s;
    }
    #status-pill .dot {
      width: 7px; height: 7px;
      border-radius: 50%;
      background: #64748b;
      transition: background 0.3s;
    }
    #status-pill.live { background: #0f2a1a; color: #4ade80; }
    #status-pill.live .dot { background: #4ade80; animation: pulse 2s infinite; }
    #status-pill.loading { background: #1e2940; color: #60a5fa; }
    #status-pill.loading .dot { background: #60a5fa; }
    #status-pill.error { background: #2a1010; color: #f87171; }
    #status-pill.error .dot { background: #f87171; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    /* Period selector */
    #period-bar {
      display: flex;
      gap: 4px;
      padding: 12px 16px;
      border-bottom: 1px solid #2d3148;
    }

    .period-btn {
      flex: 1;
      padding: 5px 0;
      background: #252836;
      border: 1px solid #2d3148;
      border-radius: 6px;
      color: #94a3b8;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s, color 0.15s, border-color 0.15s;
    }
    .period-btn:hover { background: #2d3250; color: #e2e8f0; }
    .period-btn.active {
      background: #3730a3;
      border-color: #4f46e5;
      color: #e0e7ff;
    }

    /* Stats bar */
    #stats-bar {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1px;
      background: #2d3148;
      border-bottom: 1px solid #2d3148;
    }
    .stat-cell {
      background: #1a1d27;
      padding: 10px 14px;
    }
    .stat-cell .stat-val {
      font-size: 18px;
      font-weight: 700;
      color: #f1f5f9;
      line-height: 1;
    }
    .stat-cell .stat-lbl {
      font-size: 10px;
      color: #64748b;
      margin-top: 3px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* User list */
    #users-label {
      padding: 10px 16px 4px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #475569;
      font-weight: 600;
    }

    #user-list {
      overflow-y: auto;
      flex: 1;
      padding: 4px 8px 8px;
    }

    .user-card {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .user-card:hover { background: #252836; }
    .user-card.selected { background: #252836; }

    .user-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .user-name {
      font-size: 13px;
      font-weight: 500;
      color: #cbd5e1;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .user-time {
      font-size: 10px;
      color: #475569;
      white-space: nowrap;
    }
    .user-pts {
      font-size: 10px;
      color: #475569;
    }

    /* ── Map ─────────────────────────────────────────────────── */
    #map {
      flex: 1;
      background: #0f1117;
    }

    /* Leaflet popup override */
    .leaflet-popup-content-wrapper {
      background: #1a1d27;
      color: #e2e8f0;
      border: 1px solid #2d3148;
      border-radius: 8px;
    }
    .leaflet-popup-tip { background: #1a1d27; }
    .leaflet-popup-content { font-size: 12px; line-height: 1.6; }
    .popup-user { font-weight: 600; font-size: 13px; }
    .popup-ts { color: #94a3b8; }
    .popup-coord { color: #64748b; font-size: 11px; }

    /* Scrollbar */
    #user-list::-webkit-scrollbar { width: 4px; }
    #user-list::-webkit-scrollbar-track { background: transparent; }
    #user-list::-webkit-scrollbar-thumb { background: #2d3148; border-radius: 2px; }
  </style>
</head>
<body>

<aside id="sidebar">
  <div id="sidebar-header">
    <h1>Location Dashboard</h1>
    <p id="period-label">Last 24 hours</p>
    <div id="status-pill" class="loading">
      <span class="dot"></span>
      <span id="status-text">Connecting…</span>
    </div>
  </div>

  <div id="period-bar">
    <button class="period-btn" data-hours="1">1h</button>
    <button class="period-btn" data-hours="6">6h</button>
    <button class="period-btn active" data-hours="24">24h</button>
    <button class="period-btn" data-hours="168">7d</button>
  </div>

  <div id="stats-bar">
    <div class="stat-cell">
      <div class="stat-val" id="stat-pts">—</div>
      <div class="stat-lbl">Data points</div>
    </div>
    <div class="stat-cell">
      <div class="stat-val" id="stat-users">—</div>
      <div class="stat-lbl">Active users</div>
    </div>
  </div>

  <div id="users-label">Users</div>
  <div id="user-list"></div>
</aside>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ---------------------------------------------------------------------------
// Map setup
// ---------------------------------------------------------------------------
const map = L.map('map', {
  center: [40, 0],
  zoom: 3,
  zoomControl: true,
  attributionControl: true,
});

L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://carto.com/">CARTO</a>',
  subdomains: 'abcd',
  maxZoom: 19,
}).addTo(map);

// ---------------------------------------------------------------------------
// State
// ---------------------------------------------------------------------------
const userPolylines = {};  // user_id → L.polyline
const userMarkers   = {};  // user_id → L.circleMarker
const userLastTs    = {};  // user_id → ISO timestamp string
const userPtCount   = {};  // user_id → number of points
let totalPoints = 0;
let ws = null;
let currentHours = 24;
let _firestorePositions = {};  // user_id → latest position from Firestore

// ---------------------------------------------------------------------------
// Color hash — deterministic from user_id string
// ---------------------------------------------------------------------------
function userColor(userId) {
  let hash = 0;
  for (let i = 0; i < userId.length; i++) {
    hash = userId.charCodeAt(i) + ((hash << 5) - hash);
  }
  const h = Math.abs(hash) % 360;
  return `hsl(${h}, 70%, 55%)`;
}

// ---------------------------------------------------------------------------
// Relative time
// ---------------------------------------------------------------------------
function relativeTime(isoStr) {
  if (!isoStr) return '';
  const diffMs = Date.now() - new Date(isoStr).getTime();
  const s = Math.floor(diffMs / 1000);
  if (s < 60)  return `${s}s ago`;
  if (s < 3600) return `${Math.floor(s / 60)}m ago`;
  if (s < 86400) return `${Math.floor(s / 3600)}h ago`;
  return `${Math.floor(s / 86400)}d ago`;
}

// ---------------------------------------------------------------------------
// Status pill helper
// ---------------------------------------------------------------------------
const pill     = document.getElementById('status-pill');
const pillText = document.getElementById('status-text');

function setStatus(state, text) {
  pill.className = state;  // 'loading' | 'live' | 'error' | ''
  pillText.textContent = text;
}

// ---------------------------------------------------------------------------
// Map helpers
// ---------------------------------------------------------------------------
function ensureUser(userId) {
  if (!userPolylines[userId]) {
    const color = userColor(userId);
    userPolylines[userId] = L.polyline([], {
      color, weight: 3, opacity: 0.85,
    }).addTo(map);
    userMarkers[userId] = L.circleMarker([0, 0], {
      radius: 7,
      color,
      fillColor: color,
      fillOpacity: 0.9,
      weight: 2,
    }).addTo(map);
    userPtCount[userId] = 0;
  }
}

function addPoint(userId, lat, lng, ts) {
  ensureUser(userId);
  const latlng = [lat, lng];
  userPolylines[userId].addLatLng(latlng);
  userMarkers[userId].setLatLng(latlng);
  userMarkers[userId].bindPopup(
    `<div class="popup-user" style="color:${userColor(userId)}">${userId}</div>` +
    `<div class="popup-ts">${relativeTime(ts)}</div>` +
    `<div class="popup-coord">${lat.toFixed(5)}, ${lng.toFixed(5)}</div>`
  );
  userLastTs[userId] = ts;
  userPtCount[userId] = (userPtCount[userId] || 0) + 1;
}

// ---------------------------------------------------------------------------
// Sidebar rendering
// ---------------------------------------------------------------------------
const statPts   = document.getElementById('stat-pts');
const statUsers = document.getElementById('stat-users');
const userList  = document.getElementById('user-list');

function renderSidebar() {
  statPts.textContent   = totalPoints.toLocaleString();
  statUsers.textContent = Object.keys(userPolylines).length;

  const sorted = Object.keys(userLastTs).sort((a, b) =>
    (userLastTs[b] || '').localeCompare(userLastTs[a] || '')
  );

  userList.innerHTML = '';
  for (const uid of sorted) {
    const card = document.createElement('div');
    card.className = 'user-card';
    card.innerHTML =
      `<span class="user-dot" style="background:${userColor(uid)}"></span>` +
      `<span class="user-name">${uid}</span>` +
      `<span class="user-pts">${(userPtCount[uid] || 0).toLocaleString()} pts</span>` +
      `<span class="user-time">${relativeTime(userLastTs[uid])}</span>`;
    card.addEventListener('click', () => {
      const poly = userPolylines[uid];
      if (poly) {
        const bounds = poly.getBounds();
        if (bounds.isValid()) map.fitBounds(bounds, { padding: [40, 40] });
      }
    });
    userList.appendChild(card);
  }
}

// Update relative times every 30s
setInterval(() => {
  document.querySelectorAll('.user-time').forEach((el, i) => {
    const uid = Object.keys(userLastTs).sort((a, b) =>
      (userLastTs[b] || '').localeCompare(userLastTs[a] || '')
    )[i];
    if (uid) el.textContent = relativeTime(userLastTs[uid]);
  });
}, 30_000);

// ---------------------------------------------------------------------------
// Latest positions handler (Firestore — arrives before historical_batch)
// ---------------------------------------------------------------------------
function onLatestPositions(msg) {
  _firestorePositions = {};  // reset cache
  for (const pos of msg.positions) {
    if (!pos.user_id || pos.latitude == null || pos.longitude == null) continue;
    const uid = pos.user_id;
    _firestorePositions[uid] = pos;  // cache for re-use after historical_batch
    ensureUser(uid);
    const latlng = [pos.latitude, pos.longitude];
    userMarkers[uid].setLatLng(latlng);
    userMarkers[uid].bindPopup(
      `<div class="popup-user" style="color:${userColor(uid)}">${uid}</div>` +
      `<div class="popup-ts">${relativeTime(pos.updated_at || pos.timestamp)} (current)</div>` +
      `<div class="popup-coord">${pos.latitude.toFixed(5)}, ${pos.longitude.toFixed(5)}</div>`
    );
    userLastTs[uid] = pos.updated_at || pos.timestamp;
  }
  if (msg.count > 0) {
    // fitBounds to current positions while history is loading
    const allBounds = Object.values(userMarkers)
      .map(m => m.getLatLng())
      .filter(ll => ll.lat !== 0 || ll.lng !== 0)
      .map(ll => [ll.lat, ll.lng]);
    if (allBounds.length > 0) map.fitBounds(allBounds, { padding: [60, 60] });
  }
  renderSidebar();
  setStatus('loading', 'Loading history…');
}

// ---------------------------------------------------------------------------
// Historical batch handler
// ---------------------------------------------------------------------------
function onHistoricalBatch(msg) {
  // Clear existing layers
  for (const uid of Object.keys(userPolylines)) {
    map.removeLayer(userPolylines[uid]);
    map.removeLayer(userMarkers[uid]);
  }
  Object.keys(userPolylines).forEach(k => delete userPolylines[k]);
  Object.keys(userMarkers).forEach(k => delete userMarkers[k]);
  Object.keys(userLastTs).forEach(k => delete userLastTs[k]);
  Object.keys(userPtCount).forEach(k => delete userPtCount[k]);
  totalPoints = 0;

  for (const row of msg.rows) {
    addPoint(row.user_id, row.latitude, row.longitude, row.timestamp);
    totalPoints++;
  }

  // Re-apply Firestore current positions on top of BQ trail.
  // This ensures the marker sits at the real current position even when
  // the BQ data lags behind Firestore by seconds or minutes.
  for (const [uid, pos] of Object.entries(_firestorePositions)) {
    addPoint(uid, pos.latitude, pos.longitude, pos.updated_at || pos.timestamp);
    // addPoint counts as a data point but we don't add to totalPoints
    // since it's the same event already in BQ (or a negligibly newer one)
  }

  // fitBounds over all points
  const allBounds = [];
  for (const uid of Object.keys(userPolylines)) {
    const b = userPolylines[uid].getBounds();
    if (b.isValid()) allBounds.push(b);
  }
  if (allBounds.length > 0) {
    const combined = allBounds.reduce((acc, b) => acc.extend(b));
    map.fitBounds(combined, { padding: [40, 40] });
  }

  renderSidebar();
  setStatus('live', `Live — ${totalPoints.toLocaleString()} pts`);
}

// ---------------------------------------------------------------------------
// Live update handler
// ---------------------------------------------------------------------------
function onLiveUpdate(msg) {
  if (!msg.user_id || msg.latitude == null || msg.longitude == null) return;
  addPoint(msg.user_id, msg.latitude, msg.longitude, msg.timestamp);
  totalPoints++;
  renderSidebar();
  setStatus('live', `Live — ${totalPoints.toLocaleString()} pts`);
}

// ---------------------------------------------------------------------------
// Period selector
// ---------------------------------------------------------------------------
const periodLabel = document.getElementById('period-label');
const periodLabels = { 1: 'Last 1 hour', 6: 'Last 6 hours', 24: 'Last 24 hours', 168: 'Last 7 days' };

document.querySelectorAll('.period-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentHours = parseInt(btn.dataset.hours, 10);
    periodLabel.textContent = periodLabels[currentHours] || `Last ${currentHours}h`;
    connect(currentHours);
  });
});

// ---------------------------------------------------------------------------
// WebSocket client
// ---------------------------------------------------------------------------
function connect(hours) {
  if (ws) {
    ws.onclose = null;  // suppress reconnect during intentional close
    ws.close();
  }

  _firestorePositions = {};
  setStatus('loading', 'Fetching history…');

  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${proto}//${location.host}/ws`);

  ws.onopen = () => {
    ws.send(JSON.stringify({ type: 'filter', since_hours: hours }));
  };

  ws.onmessage = (event) => {
    let msg;
    try { msg = JSON.parse(event.data); } catch { return; }

    switch (msg.type) {
      case 'latest_positions': onLatestPositions(msg); break;
      case 'historical_batch': onHistoricalBatch(msg); break;
      case 'live_update':      onLiveUpdate(msg);      break;
      case 'error':
        console.warn('[ws] server error:', msg.code, msg.message);
        setStatus('error', msg.code || 'Error');
        break;
      case 'ping':
        // silently ignored
        break;
    }
  };

  ws.onclose = () => {
    setStatus('', 'Disconnected');
    // Reconnect after 5s
    setTimeout(() => connect(currentHours), 5000);
  };

  ws.onerror = (err) => {
    console.error('[ws] error', err);
    setStatus('error', 'Connection error');
  };
}

// Boot
connect(currentHours);
</script>
</body>
</html>
